<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <title>OSM TEST</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
</head>

<body>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 94%;
        }

        a,
        button {
            font-family: "Microsoft JhengHei";
        }
    </style>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">圖書館開放資料整合系統</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#">Link</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        縣市
                    </a>
                    <div id="citys" class="dropdown-menu" aria-labelledby="navbarDropdown">

                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        圖書館類別
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Action</a>
                        <a class="dropdown-item" href="#">Another action</a>
                    </div>
                </li>
            </ul>
            <!--
            <form class="form-inline my-2 my-lg-0">
                <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
            </form>
            -->
        </div>
    </nav>
    <div id="map"></div>
    <script>
        //定義MAP
        let map;
        map = L.map('map').setView([23.546162, 120.6402133], 8);
        //加入圖層
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '<a href="https://www.openstreetmap.org/">OSM</a>',
            maxZoom: 18,
        }).addTo(map);
        //測試MARKER
        //這方選是給建置MARKER用的
        let markers = {};
        function makeMarker(sourceMap, data, action) {
            if (action == 3) {
                let locate = [data["緯度"], data["經度"]];
                let marker = L.marker(locate, {
                    icon: L.icon({
                        iconUrl: "{{url_for('static', filename='images/libarys.png')}}",
                    }),
                    fileNo: data["電話"],
                    type: "libary",
                });
                markers[data["圖書館名稱"]] =  marker;
            }
            if (action == 1) {
                sourceMap.addLayer(markers[data["圖書館名稱"]]);
            } else if (action == 0) {
                sourceMap.removeLayer(markers[data["圖書館名稱"]]);
            } else {
                //新增MARKER觸發
                markers[data["圖書館名稱"]].on('click', function () {
                    Swal.mixin({
                        width: 600,
                        padding: '3em',
                        background: '#fff url(https://sweetalert2.github.io/images/trees.png)',
                        showCancelButton: true,
                        progressSteps: ['C'],
                        backdrop: `
                                    rgba(0,0,123,0.4)
                                    url(` + data.representImage + `)
                                    center
                                    no-repeat
                                `
                    }).queue([
                        {
                            title: data["圖書館名稱"],
                            text: data["簡介"],
                        }
                    ])
                });
            }

        }
        //我要開始執行了喔
        $.getJSON('/getSchools', function (apiData) {
            console.log(apiData.status);
            let water = {};
            apiData.data.map(
                school => {
                    let city = school["地址"].advance.locate.baddr2;
                    let area = school["地址"].advance.locate.bname2;
                    if (!water[city]) {
                        water[city] = {};//創建城市
                    } else if (!water[city][area]) {//不存在區域
                        water[city][area] = 0;//創建區域
                    }
                    water[city][area]++;
                    if (water[city][area] < 5) {
                        //makeMarker(map, school);
                    }
                }
            )
        });
        let libaryDatas = {};
        let cityWord = "";
        function showClick() {
            cityWord = "";
            $('input:checkbox:checked[name="citycheck"]').each(
                function () {
                    cityWord += this.value + ",";
                }
            );
            libaryDatas.data.map(lbs => {
                if (cityWord.indexOf(lbs["縣市別"]) > -1) {
                    lbs.publicLibary.map(
                        lb => {
                            makeMarker(map, lb, 1);
                        }
                    )
                } else {
                    lbs.publicLibary.map(
                        lb => {
                            makeMarker(map, lb, 0);
                        }
                    )
                }
            });
        }
        $.getJSON('/getLibary', function (apiData) {
            console.log(apiData.status);
            libaryDatas = apiData;
            let water = {};
            apiData.data.map(
                d => {
                    let city = d["縣市別"];
                    $("#citys").append(`
                        <a class="dropdown-item" href="#">
                            <input class="form-check-input" type="checkbox" name="citycheck" value="`+ city + `" onclick="showClick()">
                            <label class="form-check-label" for="citycheck">` + city + `</label>
                        </a>
                    `);
                    d.publicLibary.map(
                        lb => {
                            makeMarker(map, lb, 3);
                        }
                    )
                }
            )
        });
    </script>
</body>

</html>